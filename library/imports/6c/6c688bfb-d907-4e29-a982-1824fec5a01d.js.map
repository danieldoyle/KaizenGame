{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\Player.js"],"names":["cc","Class","extends","Component","properties","canvas","Node","speed","v2","maxSpeed","gravity","drag","direction","jumpSpeed","jumpAudio","default","url","AudioClip","spriteList","type","SpriteFrame","onLoad","eventManager","addListener","event","EventListener","KEYBOARD","onKeyPressed","bind","onKeyReleased","node","collisionX","collisionY","prePosition","preStep","touchingNumber","self","onEnable","director","getCollisionManager","enabled","onDisable","keyCode","KEY","a","left","sprite","getComponent","Sprite","spriteFrame","d","right","w","up","jumping","y","audioEngine","playEffect","onCollisionEnter","other","group","otherAabb","world","aabb","otherPreAabb","preAabb","clone","selfAabb","selfPreAabb","x","Intersection","rectRect","xMax","parent","xMin","width","touchingX","yMax","yMin","height","touchingY","onCollisionStay","motion","_moveAxis","_movedDiff","onCollisionExit","update","dt","Math","abs"],"mappings":"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","file":"Player.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        canvas: cc.Node,\n        speed: cc.v2(0, 0),\n        maxSpeed: cc.v2(2000, 2000),\n        gravity: -2000,\n        drag: 1000,\n        direction: 0,\n        jumpSpeed: 700,\n        jumpAudio: {\n            default: null,\n            url: cc.AudioClip\n        },\n        spriteList: {\n            default: [],\n            type: [cc.SpriteFrame]\n        }\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        cc.eventManager.addListener({\n            event: cc.EventListener.KEYBOARD,\n            onKeyPressed: this.onKeyPressed.bind(this),\n            onKeyReleased: this.onKeyReleased.bind(this),\n        }, this.node);\n\n        this.collisionX = 0;\n        this.collisionY = 0;\n\n        this.prePosition = cc.v2();\n        this.preStep = cc.v2();\n\n        this.touchingNumber = 0;\n\n        var self = this;\n \n    },\n\n    onEnable: function () {\n        cc.director.getCollisionManager().enabled = true;\n    },\n\n    onDisable: function () {\n        cc.director.getCollisionManager().enabled = false;\n    },\n    \n    onKeyPressed: function (keyCode, event) {\n        switch(keyCode) {\n            case cc.KEY.a:\n            case cc.KEY.left:   \n                    if (this.direction != -1)             \n                    { \n                        this.direction = -1;\n                        var sprite = this.getComponent(cc.Sprite);\n                        sprite.spriteFrame = this.spriteList[0];\n                    }\n                break;\n            case cc.KEY.d:\n            case cc.KEY.right:\n                    if (this.direction != 1)\n                    {\n                        this.direction = 1;\n                        var sprite = this.getComponent(cc.Sprite);\n                        sprite.spriteFrame = this.spriteList[1];\n                    }\n                break;\n            case cc.KEY.w:\n            case cc.KEY.up:\n                if (!this.jumping) {\n                    this.jumping = true;\n                    this.speed.y = this.jumpSpeed; \n                    cc.audioEngine.playEffect(this.jumpAudio, false);\n       \n                }\n                break;\n        }\n    },\n    \n    onKeyReleased: function (keyCode, event) {\n        switch(keyCode) {\n            case cc.KEY.a:\n            case cc.KEY.left:\n            case cc.KEY.d:\n            case cc.KEY.right:\n                this.direction = 0;\n                break;\n        }\n    },\n    \n    onCollisionEnter: function (other, self) {\n        if (other.node.group === 'JIRA') {\n            return;\n        }\n        this.touchingNumber ++;\n        \n        // 1st step \n        // get pre aabb, go back before collision\n        var otherAabb = other.world.aabb;\n        var otherPreAabb = other.world.preAabb.clone();\n\n        var selfAabb = self.world.aabb;\n        var selfPreAabb = self.world.preAabb.clone();\n\n        // 2nd step\n        // forward x-axis, check whether collision on x-axis\n        selfPreAabb.x = selfAabb.x;\n        otherPreAabb.x = otherAabb.x;\n\n        if (cc.Intersection.rectRect(selfPreAabb, otherPreAabb)) {\n            if (this.speed.x < 0 && (selfPreAabb.xMax > otherPreAabb.xMax)) {\n                this.node.x = otherPreAabb.xMax - this.node.parent.x;\n                this.collisionX = -1;\n            }\n            else if (this.speed.x > 0 && (selfPreAabb.xMin < otherPreAabb.xMin)) {\n                this.node.x = otherPreAabb.xMin - selfPreAabb.width - this.node.parent.x;\n                this.collisionX = 1;\n            }\n\n            this.speed.x = 0;\n            other.touchingX = true;\n            return;\n        }\n\n        // 3rd step\n        // forward y-axis, check whether collision on y-axis\n        selfPreAabb.y = selfAabb.y;\n        otherPreAabb.y = otherAabb.y;\n\n        if (cc.Intersection.rectRect(selfPreAabb, otherPreAabb)) {\n            if (this.speed.y < 0 && (selfPreAabb.yMax > otherPreAabb.yMax)) {\n                this.node.y = otherPreAabb.yMax - this.node.parent.y;\n                this.jumping = false;\n                this.collisionY = -1;\n            }\n            else if (this.speed.y > 0 && (selfPreAabb.yMin < otherPreAabb.yMin)) {\n                this.node.y = otherPreAabb.yMin - selfPreAabb.height - this.node.parent.y;\n                this.collisionY = 1;\n            }\n            \n            this.speed.y = 0;\n            other.touchingY = true;\n        }    \n        \n    },\n    \n    onCollisionStay: function (other, self) {\n        if (other.node.group === 'JIRA') {\n            return;\n        }\n        \n        if (this.collisionY === -1) {\n            if (other.node.group === 'Platform') {\n                var motion = other.node.getComponent('Platform');\n                if (motion) {\n                    if (motion._moveAxis == 0)\n                    {\n                        this.node.x += motion._movedDiff;\n                    }\n                    else\n                    {\n                        this.node.y += motion._movedDiff;\n                    }\n                }\n            }\n\n        }\n    },\n    \n    onCollisionExit: function (other) {\n        if (other.node.group === 'JIRA') {\n            return;\n        }\n\n        this.touchingNumber --;\n        \n\n        if (other.touchingX) {\n            this.collisionX = 0;\n            other.touchingX = false;\n        }\n        else if (other.touchingY) {\n            other.touchingY = false;\n            this.collisionY = 0;\n            this.jumping = true;\n        }\n    },\n    \n    update: function (dt) {\n        if (this.collisionY === 0) {\n            this.speed.y += this.gravity * dt;\n            if (Math.abs(this.speed.y) > this.maxSpeed.y) {\n                this.speed.y = this.speed.y > 0 ? this.maxSpeed.y : -this.maxSpeed.y;\n            }\n        }\n\n        if (this.direction === 0) {\n            if (this.speed.x > 0) {\n                this.speed.x -= this.drag * dt;\n                if (this.speed.x <= 0) this.speed.x = 0;\n            }\n            else if (this.speed.x < 0) {\n                this.speed.x += this.drag * dt;\n                if (this.speed.x >= 0) this.speed.x = 0;\n            }\n        }\n        else {\n            this.speed.x += (this.direction > 0 ? 1 : -1) * this.drag * dt;\n            if (Math.abs(this.speed.x) > this.maxSpeed.x) {\n                this.speed.x = this.speed.x > 0 ? this.maxSpeed.x : -this.maxSpeed.x;\n            }\n        }\n\n        if (this.speed.x * this.collisionX > 0) {\n            this.speed.x = 0;\n        }\n        \n        this.prePosition.x = this.node.x;\n        this.prePosition.y = this.node.y;\n\n        this.preStep.x = this.speed.x * dt;\n        this.preStep.y = this.speed.y * dt;\n        \n        this.node.x += this.speed.x * dt;\n        this.node.y += this.speed.y * dt;\n    },\n});\n"]}